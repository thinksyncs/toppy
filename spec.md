Toppy OSS仕様書

1. ソフトウェア仕様書

本ツールは Rust 製の CLI ベース接続ツールであり、HTTP/3 MASQUE（主に RFC 9484 CONNECT‑IP）を用いてリモートネットワークへの安全なアクセスを提供します。目的は技術者が自宅や検証環境・顧客環境へアクセスする際の鍵管理・経路確立・監査の面倒を吸収し、最小権限・短寿命クレデンシャル・ポリシー管理を実現することです。主要な仕様を以下にまとめます。
	•	対象ユーザ：SRE、セキュリティ担当者、開発者など。Linux/Windows/macOS から検証機や自宅 PC へ安全にアクセスしたい技術者を想定します。
	•	主要機能
	•	toppy login：OIDC デバイスコードフロー等で認証・認可を行い、短寿命トークンを取得します。完全 CLI で実行可能で、必要に応じブラウザを開くだけに留めます。
	•	toppy up/down：HTTP/3 MASQUE（CONNECT‑IP）を用いてトンネルを確立し、TUN インタフェースを作成して指定 CIDR・ポートへのルーティングを設定します。セッションは短寿命で、自動失効します。
	•	toppy ssh <target>：ポリシーで許可されたターゲットへ接続する際に短寿命 SSH 証明書を取得し、OpenSSH クライアントに渡します。長期鍵を配布しません。
	•	toppy rdp <target>：Windows ターゲットへ接続する場合、ローカルポートフォワード（例：localhost:<ランダムポート>→ターゲット 3389）を作成した後、OS 標準の RDP クライアントを起動します。
	•	toppy pf <target> --local <port> --remote <port>：任意 TCP ポートのフォワードを安全に行います。許可されたポートに限定されます。
	•	toppy target add/list：YAML/JSON でターゲットを宣言的に管理し、CIDR/ポート単位の許可ポリシーを定義します。デフォルトは deny です。
	•	toppy audit tail：誰がいつどこへ接続したかなどの監査ログを確認できます。ログはローカルおよびゲートウェイ側に記録されます。
	•	toppy doctor：環境診断コマンド。設定の妥当性、DNS 解決、HTTP/3 接続、認証トークン期限、TUN 権限、MTU 推定、ポリシー適用等をチェックし、成功・警告・失敗を JSON および人間向け出力で返します。
	•	安全設計
	•	短寿命セッション：トークンや証明書は通常 5〜30 分で失効し、漏洩時の被害範囲を限定します。
	•	最小権限ポリシー：ターゲットごとに許可された CIDR/ポートを厳格に定義し、それ以外は拒否します。通信量のレート制御フックも用意します。
	•	監査：接続開始・終了、許可・拒否の理由、宛先、転送量などを機械可読 JSONL 形式で保存し、必要に応じ改ざん耐性のあるストレージへ送信できるよう設計します。
	•	再現可能な導入：docker compose によりゲートウェイ・テスト環境を簡単に起動でき、README に 5 分以内のクイックスタートを記載します。
	•	非目標
	•	初期リリースでは完全な L3 VPN（ネットワーク丸ごとの透過共有）を目指さず、アプリケーション／ポート単位の安全な接続に集中します。
	•	OIDC 以外の IdP や多要素認証の対応は後段で検討します。
	•	CONNECT‑UDP や他トランスポートへの対応は Phase 3 以降で追加します。

2. TODO / ゲート

TODO と進捗、ゲートの定義は `TODO.md` を参照してください。
